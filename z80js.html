<!DOCTYPE html>
<html>
<head>
<title>A Javascript Based Z80 Disassembler and Simulator
</title>
<style>
.box {
  float: left;
  width: 50%;
  padding: 0px;
}
.clearfix::after {
  clear: both;
  display: table;
}
</style>
</head>
<body>

<div class="clearfix">
<div class="box" style="background-color:#ddd">
<p style="margin-left:5%;margin-right:5%;width:90%">Binary Code (I08HEX or S-Record Format)</p>
<textarea  name="iHex" id="iHex" rows="4" style="margin-left:5%;margin-right:5%;width:90%">
</textarea><br/>
<button style="margin-left:5%;margin-right:5%;">Convert IHex to Binary</button><button style="margin-left:5%;margin-right:5%;">Convert S-Record to Binary</button>
</div>

<div class="box" style="background-color:#eee">
<p style="margin-left:5%;margin-right:5%;width:90%">Binary Code (Hex-Binary)</p>
<textarea  name="binary" id="binary" rows="4" style="margin-left:5%;margin-right:5%;width:90%">
3E0FD302D30318287036737A7D74360F
6D682D2A632C606E4C74C1549A701919
5927ED78A358494A111674D277505110 
1100020E0179D3012108007EADD30006 
8010FE23AF79174FD30130EF1BAFBB20 
E2BA20DF1100020E0179D3012110007E
ADD300068010FE23AF79174FD30130EF 
1BAFBB20E2BA20DF1100020E0179D301 
2118007EADD300068010FE23AF79174F 
D30130EF1BAFBB20E2BA20DF1100020E 
0179D3012120007EADD300068010FE23 
AF79174FD30130EF1BAFBB20E2BA20DF 
1100020E0179D3012128007EADD30006 
8010FE23AF79174FD30130EF1BAFBB20 
E2BA20DF110002189200000000000000 
783F7971717938000000000000000000 
7D793F39773976790000000000000000 
546DDB4F865B6D3F0000000000000000 
7906CF5BE66D7D6D0000000000000000 
393F5EF93F7F066D
</textarea><br/>
<button style="margin-left:5%;margin-right:5%;" onclick="javascript:disassemble()">Disassemble</button>
</div>
</div>

<div>
<hr style="border:solid #aaaaff 1px;height:1px;margin-top"/>
<p>Z80 Archictecture and Register</p>
<!--<div style="width:100%;height:*;position:relative;background-Image:url(Z80_arch.svg);background-size:100%;background-repeat:no-repeat;">-->
<div style="width:100%;height:*;max-width:250mm;position:relative;background-color:#dbf1ff">
<img src="Z80_arch.svg" style="width:100%;opacity: 0.7;">
<div style="position:absolute;left:35.6%;top:25%">
<label for="Wdash"> W'<input type=text name="Wdash" id="Wdash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label></div>
<div style="position:absolute;left:43%;top:25%">
<label for="Zdash">Z'<input type=text name="Zdash" id="Zdash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/></label> </div>
<div style="position:absolute;left:36%;top:30%">
<label for="Bdash">B'<input type=text name="Bdash" id="Bdash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:43%;top:30%">
<label for="Cdash">C'<input type=text name="Cdash" id="Cdash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label></div>
<div style="position:absolute;left:36%;top:36%">
<label for="Ddash">D'<input type=text name="Ddash" id="Ddash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:43%;top:36%">
<label for="Edash">E'<input type=text name="Edash" id="Edash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:36%;top:42%">
<label for="Hdash">H'<input type=text name="Hdash" id="Hdash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:43%;top:42%">
<label for="Ldash">L'<input type=text name="Ldash" id="Ldash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>

<div style="position:absolute;left:50.9%;top:25%">
<label for="W">W <input type=text name="W" id="W" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:58%;top:25%">
<label for="Z" >Z <input type=text name="Z" id="Z" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:51%;top:30%">
<label for="B" >B <input type=text name="B" id="B" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:58%;top:30%">
<label for="C">C <input type=text name="C" id="C" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:51%;top:36%">
<label for="D" >D <input type=text name="D" id="D" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:58%;top:36%">
<label for="E" >E <input type=text name="E" id="E" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:51%;top:42%">
<label for="H" >H <input type=text name="H" id="H" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:58%;top:42%">
<label for="L" >L <input type=text name="L" id="L" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>

<div style="position:absolute;left:46%;top:47%">
<label for="IX" >IX <input type=text name="IX" id="IX" value="0x0000" style="width:4em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:46%;top:52%">
<label for="IY" >IY <input type=text name="IY" id="IY" value="0x0000" style="width:4em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:46%;top:57%">
<label for="SP" >SP <input type=text name="SP" id="SP" value="0x0000" style="width:4em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:46%;top:62%">
<label for="PC" >PC <input type=text name="PC" id="PC" value="0x0000" style="width:4em;background-color:#f4d7d7"/> </label> </div>

<div style="position:absolute;left:76.2%;top:32%">
<label for="Adash" >A'<input type=text name="Adash" id="Adash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:76.2%;top:26%">
<label for="A" >A <input type=text name="A" id="A" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:86%;top:32%">
<label for="Fdash" >F'<input type=text name="Fdash" id="Fdash" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>
<div style="position:absolute;left:86%;top:26%">
<label for="F" >F <input type=text name="F" id="F" value="0x00" style="width:2.5em;background-color:#f4d7d7"/> </label> </div>

</div>
<p style="text-align:right;color:#aaa;font-size:small;margin-top:0px;margin-bottom:0px"> Image credit: Appaloosa, 17 October 2007, https://commons.wikimedia.org/wiki/File:Z80_arch.svg</p>
</div>

<hr style="border:solid #aaaaff 1px;height:1px;margin-top"/>

<p>Z80 Disassembler and Simulator</p>

<div class="clearfix">
<button onclick="javascript:reset()">Reset</button>
<button onclick="javascript:run()">Run</button>
<button onclick="javascript:step()">Step 1</button>
<button onclick="javascript:stepN()">Step N</button>
<label for="N">N <input type=text name="N" id="N" value="2" style="width:4em;background-color:#f4d7d7"/> </label>
<label for="autoStep">Auto Step<input type="checkbox" name="autoStep" id="autoStep" onclick="javascript:autoStep()"/></label>
<label for="Hz"><input type=text name="Hz" id="Hz" value="1" style="width:2em;background-color:#f4d7d7"/>Hz</label>
<button onclick="javascript:runToAddr()">Run to addr</button>
<label for="Bkpt1">Addr <input type=text name="Addr" id="Addr" value="0x03" style="width:4em;background-color:#f4d7d7"/>  </label>
<label for="Bkpt1">Bkpt1 <input type=text name="Bkpt1" id="Bkpt1" value="0x00" style="width:4em;background-color:#f4d7d7"/><input type="checkbox" name="Bkpt1Enabled" id="Bkpt1Enabled" disabled="disabled" />  </label>
<label for="Bkpt2">Bkpt2 <input type=text name="Bkpt2" id="Bkpt2" value="0x00" style="width:4em;background-color:#f4d7d7"/><input type="checkbox" name="Bkpt2Enabled" id="Bkpt2Enabled" disabled="disabled" />  </label>
</div>

<hr style="border:solid #aaaaff 1px;height:1px;margin-top"/>

<p>Output</p>
<!-- I shall not use spaces to format text -->
<div class="clearfix">
<div class="box" style="background-color:#ddd">
<p style="margin-left:5%;margin-right:5%;width:90%">Disassembly</p>
<p style="margin-left:5%;margin-right:5%;width:90%;margin-bottom:0px;">address&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd+data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mnemonic</p>
<textarea  name="disassembly" id="disassembly" rows="50" style="margin-left:5%;margin-right:5%;width:90%">
</textarea><br/>
</div>
<div class="box" style="background-color:#eee">
<p style="margin-left:5%;margin-right:5%;width:90%">Exceution Log</p>
<p style="margin-left:5%;margin-right:5%;width:90%;margin-bottom:0px;">step&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;address&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd+data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mnemonic</p>
<textarea  name="disassembly" id="excection" rows="50" style="margin-left:5%;margin-right:5%;width:90%">
</textarea><br/>
</div>
</div>

<hr style="border:solid #aaaaff 1px;height:1px;margin-top"/>

<p>Call Graph</p>
<button onclick="javascript:drawCallGraph()">Draw Call Graph</button>
<div style="background-color:#ddd">
<p style="margin-left:2.5%;margin-right:2.5%;width:90%">SVG Call Graph of Excecution</p>
<canvas id="CallGraph" width="200" height="100"></canvas>
</div>

<hr style="border:solid #aaaaff 1px;height:1px;margin-top"/>

<p>Address Based Flow Graph</p>
<button onclick="javascript:drawFlowGraph()">Draw Flow Graph</button>
<div style="background-color:#ddd">
<p style="margin-left:2.5%;margin-right:2.5%;width:90%">SVG Flow Graph of Excecution</p>
<canvas id="FlowGraph" width="200" height="100"></canvas>
</div>


<script language="javascript">
console.log("Z80 Disassembler and Simulator started");

var binaryBytes;
var inOut = new Array(256); //registers reachable by the in and out instructions
var disassembly=""; //holds the output of the disassembly
var excection=""; //holds the ouput of the excection
var stepCounter = 0;
var maxSteps=100;
var autoStepTimer;


//registers
var a=0;
var adash=0;
var f=0;
var fdash=0;
var w=0;
var wdash=0;
var z=0;
var zdash=0;
var b=0;
var bdash=0;
var c=0;
var cdash=0;
var d=0;
var ddash=0;
var e=0;
var edash=0;
var h=0;
var hdash=0;
var l=0;
var ldash=0;
var ix=0
var iy=0;
var sp=0;
var pc=0;

function pad(value, width) {
  value = value + "";
  return value.length >= width ? value : new Array(width - value.length + 1).join('0') + value;
}


function asQwordHex(value){
return "0x"+pad(value.toString(16),16);
}

function asDwordHex(value){
return "0x"+pad(value.toString(16),8);
}

function asWordHex(value){
return "0x"+pad(value.toString(16),4);
}

function asByteHex(value){
return "0x"+pad(value.toString(16),2);
}

function run(){
	if(binaryBytes!=undefined){
		while(excecute('RUN'));
	}
}

function step(){
	if(binaryBytes!=undefined){
		excecute('RUN');
	}
}

function stepN(){
	if(binaryBytes!=undefined){
		var i=1;
		var j=document.getElementById("N").value;
		while(excecute('RUN')&&i<j){
			i++;
		}
	}
}

function autoStep(){
	if(binaryBytes==undefined){
		document.getElementById("autoStep").checked=false;
		return;
	}
	if(document.getElementById("autoStep").checked==true){
		console.log("auto step on");
		var hz=document.getElementById("Hz").value;
		autoStepTimer=setInterval(step, 1000/hz);
	}else{
		console.log("auto step off");
		clearTimeout(autoStepTimer);
	}
}

function runToAddr(){
	if(binaryBytes!=undefined){
		var addr = parseInt(document.getElementById("Addr").value, 16);
		while(pc!=addr&&excecute('RUN')){
			//console.log("addr: "+addr+" pc "+pc);			
		}
	}
}

function reset(){
	document.getElementById("excection").value="";
	binaryBytes=undefined;
	inOut = new Array(256);
	disassembly="";
	excection="";
	disassemble();
	stepCounter = 0;
	//reset registers
	a=0;
	adash=0;
	f=0;	
	fdash=0;
	w=0;
	wdash=0;
	z=0;
	zdash=0;
	b=0;
	bdash=0;
	c=0;
	cdash=0;
	d=0;
	ddash=0;
	e=0;
	edash=0;
	h=0;
	hdash=0;
	l=0;
	ldash=0;
	ix=0
	iy=0;
	sp=0;
	pc=0;
}

function disassemble(){
	var binary=document.getElementById("binary").value;
	binary = binary.toUpperCase();
	binary = binary.replace(/[^A-Z0-9]/gi,"");
	console.log("Ascii Encoded length: "+binary.length);
	binaryBytes = new Uint8Array(binary.length/2);
	console.log("Binary length: "+binaryBytes.length);
	
	for(var i=0;i<binary.length/2;i++){
		//disassembly+=binary[2*i]+""+binary[2*i+1]+"\n";
		binaryBytes[i]=parseInt("0x"+binary[2*i]+""+binary[2*i+1]);
		//console.log(binaryBytes[i]);
	}
	disassembly="";
	stepCounter = 0;
	pc=0;
	while(excecute('DISASSEMBLE'));
}

function excecute(excectionType){

  var state="DISASSEMBLE";
  state=excectionType;

  var continueExecute=true;

  stepCounter++;
  var mnemonic="";
  var currentOpcode=binaryBytes[pc];
  if(currentOpcode==undefined){
  currentOpcode=0x00;
  }
  //console.log(pc.toString(16)+" "+currentOpcode.toString(16));
  
  switch(currentOpcode){
    case 0x00: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"nop");
		pc+=1;
	  }
	  break;
	case 0x02: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld (bc),a");
		pc+=1;
	  }
	  break;
	case 0x06: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"ld b,"+asByteHex(binaryBytes[pc+1]));
		b=binaryBytes[pc+1];
		pc+=2;
	  }
	  break;  
    case 0x0e: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"ld c,"+asByteHex(binaryBytes[pc+1]));
		c=binaryBytes[pc+1];
		pc+=2;
	  }
	  break;
    case 0x10: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"djnz "+asWordHex((binaryBytes[pc+1]<<24 >>24)+pc+2));
		//console.log(".");
		if(state=="DISASSEMBLE"){
			pc+=2;
	    }else{
			if(b!=0){
				pc+=2+(binaryBytes[pc+1]<<24 >>24);
				b--;
			}else {
				pc+=2;
			}
			
		}
	  }
	  break;
    case 0x11: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+" "+asByteHex(binaryBytes[pc+2])+"\t"+"ld de,"+asWordHex(binaryBytes[pc+2]*256+binaryBytes[pc+1]));
		d=binaryBytes[pc+2];
		e=binaryBytes[pc+1];
		pc+=3;
	  }
	  break;
    case 0x17: {
	    mnemonic=("m"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"rla");
		console.warn("not implemented");
		pc+=1;
	  }
	  break;
    case 0x18: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"jr "+asWordHex((binaryBytes[pc+1]<<24 >>24)+pc+2))
		//console.log(".");
		if(state=="DISASSEMBLE"){
			pc+=2;
	    }else{
			pc+=2+(binaryBytes[pc+1]<<24 >>24);
		}
	  }
	  break;
	case 0x19: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"add hl,de");
		pc+=1;
	  }
	  break;
	case 0x1b: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"dec de");
		pc+=1;
	  }
	  break;
	case 0x20: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"jr nz,"+asByteHex((binaryBytes[pc+1]<<24 >>24)+pc+2));
		//console.log(".");
		if(state=="DISASSEMBLE"){
			pc+=2;
	    }else{
			pc+=2+(binaryBytes[pc+1]<<24 >>24);
		}
	  }
	  break;
	case 0x21: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+" "+asByteHex(binaryBytes[pc+2])+"\t"+"ld hl,"+asWordHex(binaryBytes[pc+2]*256+binaryBytes[pc+1]));
		h=binaryBytes[pc+2];
		l=binaryBytes[pc+1];
		pc+=3;
	  }
	  break;
	case 0x23: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"inc hl");
		if(l>=255){
			l=0;
			h++;
		}else{
			l++;
		}
		pc+=1;
	  }
	  break;
	case 0x27: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"daa");
		pc+=1;
	  }
	  break;
	case 0x2a: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+" "+asByteHex(binaryBytes[pc+2])+"\t"+"ld (hl),"+asWordHex(binaryBytes[pc+2]*256+binaryBytes[pc+1]));
		pc+=3;
	  }
	  break;
	case 0x2d: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"dec l");
		pc+=1;
	  }
	  break;
    case 0x30: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"jr nc,"+asByteHex((binaryBytes[pc+1]<<24 >>24)+pc+2));
		//console.log(".");
		if(state=="DISASSEMBLE"){
			pc+=2;
	    }else{
			pc+=2+(binaryBytes[pc+1]<<24 >>24);
		};
	  }
	  break;
	case 0x36: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"ld (hl),"+asByteHex(binaryBytes[pc+1]));
		pc+=2;
	  }
	  break;
	case 0x38: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"jr c,"+asByteHex((binaryBytes[pc+1]<<24 >>24)+pc+2));
		//console.log(".");
		if(state=="DISASSEMBLE"){
			pc+=2;
	    }else{
			pc+=2+(binaryBytes[pc+1]<<24 >>24);
		};
	  }
	  break;
	case 0x39: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"add hl,sp");
		pc+=1;
	  }
	  break;
	case 0x3E: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"ld a,"+asByteHex(binaryBytes[pc+1]));
		a=binaryBytes[pc+1];
		pc+=2;
	  }
	  break;
	case 0x3f: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ccf");
		pc+=1;
	  }
	  break;
    case 0x49: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld c,c");
		pc+=1;
	  }
	  break;
	case 0x4a: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld c,d");
		pc+=1;
	  }
	  break;
	case 0x4c: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld c,h");
		pc+=1;
	  }
	  break;
    case 0x4f: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld c,a");
		c=a;
		pc+=1;
	  }
	  break;
    case 0x51: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld d,c");
		pc+=1;
	  }
	  break;
	case 0x54: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld d,h");
		pc+=1;
	  }
	  break;
    case 0x58: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld e,b");
		pc+=1;
	  }
	  break;
	case 0x59: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld e,c");
		pc+=1;
	  }
	  break;
	case 0x5b: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld e,e");
		pc+=1;
	  }
	  break;
	case 0x5e: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld e,(hl)");
		pc+=1;
	  }
	  break;
	case 0x60: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld h,b");
		pc+=1;
	  }
	  break;
	case 0x68: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld l,b");
		pc+=1;
	  }
	  break;
	case 0x6d: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld l,l");
		pc+=1;
	  }
	  break;
	case 0x6e: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld l,(hl)");
		pc+=1;
	  }
	  break;
    case 0x70: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld (hl),b");
		pc+=1;
	  }
	  break;
	case 0x71: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld (hl),c");
		pc+=1;
	  }
	  break;
	case 0x74: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld (hl),h");
		pc+=1;
	  }
	  break;
	case 0x76: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"halt");
		pc+=1;
	  }
	  break;
	case 0x77: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld (hl),a");
		pc+=1;
	  }
	  break;
	case 0x78: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld a,b");
		pc+=1;
	  }
	  break;
	case 0x79: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld a,c");
		a=c;
		pc+=1;
	  }
	  break;
	case 0x7a: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld a,d");
		pc+=1;
	  }
	  break;
	case 0x7d: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld a,l");
		pc+=1;
	  }
	  break;
    case 0x7e: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld a,(hl)");
		a=binaryBytes[binaryBytes[h]*256+binaryBytes[l]];
		if(a==undefined){a=0;}
		pc+=1;
	  }
	  break;
    case 0x7f: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld a,a");
		pc+=1;
	  }
	  break;
	case 0x86: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"add a,(hl)");
		pc+=1;
	  }
	  break;
    case 0x9a: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"sbc a,d");
		pc+=1;
	  }
	  break;
	case 0xa3: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"and e");
		pc+=1;
	  }
	  break;
    case 0xad: {
	    mnemonic=("m"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"xor l");
		console.warn("not implemented");
		pc+=1;
	  }
	  break;
    case 0xaf: {
	    mnemonic=("m"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"xor a");
		console.warn("not implemented");
		pc+=1;
	  }
	  break;
	case 0xba: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"cp d");
		pc+=1;
	  }
	  break;
	case 0xbb: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"cp e");
		pc+=1;
	  }
	  break;
	case 0xC1: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"pop bc");
		pc+=1;
	  }
	  break;
     case 0xD2: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+" "+asByteHex(binaryBytes[pc+2])+"\t"+"jp nc,"+asWordHex(binaryBytes[pc+2]*256+binaryBytes[pc+1]));
		//console.log(".");
		if(state=="DISASSEMBLE"){
			pc+=3;
	    }else{
			pc+=binaryBytes[pc+2]*256+binaryBytes[pc+1];
		}
	  }
	  break;
	case 0xD3: {
	    mnemonic=(" "+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"out ("+asByteHex(binaryBytes[pc+1])+"),a");
		inOut[binaryBytes[pc+1]]=a;
		pc+=2;
	  }
	  break;
	case 0xDB: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"in a,("+asByteHex(binaryBytes[pc+1])+")");
		pc+=2;
	  }
	  break
	case 0xE6: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"and "+asByteHex(binaryBytes[pc+1])+"");
		pc+=2;
	  }
	  break;
	case 0xED: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+" "+asByteHex(binaryBytes[pc+1])+"\t"+"in a,c");
		pc+=2;
	  }
	  break;
	case 0xF9: {
	    mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"ld sp,hl");
		pc+=1;
	  }
	  break;
	default:{
		mnemonic=("x"+asWordHex(pc)+":\t"+asByteHex(binaryBytes[pc])+"    \t"+"undefined op code "+asByteHex(binaryBytes[pc]));
	    pc++;
		}
		break;
 }
  //console.log(mnemonic);
    if(state=="DISASSEMBLE"){
		disassembly+=mnemonic+"\n";
		if(pc>=binaryBytes.length){
			continueExecute=false;
		}
		document.getElementById("disassembly").value=disassembly;
	}else{
	    mnemonic=pad(stepCounter,6)+": "+mnemonic;
		document.getElementById("excection").value+=mnemonic+"\n";
		excection+=mnemonic+"\n";
		if(stepCounter>=maxSteps||currentOpcode==0x76){//0x76=halt
			continueExecute=false;
		}
		document.getElementById("excection").value=excection;
		document.getElementById("A").value=""+asByteHex(a);
		document.getElementById("Adash").value=""+asByteHex(adash);
		document.getElementById("F").value=""+asByteHex(f);
		document.getElementById("Fdash").value=""+asByteHex(fdash);
		document.getElementById("W").value=""+asByteHex(w);
		document.getElementById("Wdash").value=""+asByteHex(wdash);
		document.getElementById("Z").value=""+asByteHex(z);
		document.getElementById("Zdash").value=""+asByteHex(zdash);
		document.getElementById("B").value=""+asByteHex(b);
		document.getElementById("Bdash").value=""+asByteHex(bdash);
		document.getElementById("C").value=""+asByteHex(c);
		document.getElementById("Cdash").value=""+asByteHex(cdash);
		document.getElementById("D").value=""+asByteHex(d);
		document.getElementById("Ddash").value=""+asByteHex(ddash);
		document.getElementById("E").value=""+asByteHex(e);
		document.getElementById("Edash").value=""+asByteHex(edash);
		document.getElementById("H").value=""+asByteHex(h);
		document.getElementById("Hdash").value=""+asByteHex(hdash);
		document.getElementById("L").value=""+asByteHex(l);
		document.getElementById("Ldash").value=""+asByteHex(ldash);
		document.getElementById("IX").value=""+asWordHex(ix);
		document.getElementById("IY").value=""+asWordHex(iy);
		document.getElementById("SP").value=""+asWordHex(sp);
		document.getElementById("PC").value=""+asWordHex(pc);
	}
	   
	return continueExecute;

}

function drawCallGraph(){
var canvas = document.getElementById("CallGraph");
var canvasContext = canvas.getContext("2d");
canvasContext.moveTo(0, 0);
canvasContext.lineTo(200, 100);
canvasContext.stroke(); 
}

function drawFlowGraph(){
var canvas = document.getElementById("FlowGraph");
var canvasContext = canvas.getContext("2d");
canvasContext.moveTo(0, 100);
canvasContext.lineTo(200, 0);
canvasContext.stroke(); 
}

</script>

</body>
</html>